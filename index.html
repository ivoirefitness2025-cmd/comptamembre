<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIT TRACK PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/phosphor-icons/1.4.2/css/phosphor.min.css" rel="stylesheet">
    <style>
        /* Styles Mobile App Native */
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
        input, select, textarea { font-size: 16px !important; user-select: text; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen flex flex-col overflow-hidden selection:bg-blue-100">

    <!-- VUE CONNEXION (PIN PAD) -->
    <div id="login-view" class="absolute inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-6">
        <div class="mb-8 text-center">
            <div class="bg-blue-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/30">
                <i class="ph-bold ph-barbell text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-white tracking-tight">FIT TRACK</h1>
            <p class="text-slate-400 text-sm mt-1">Gestion Salle de Sport</p>
        </div>

        <!-- PIN Display -->
        <div class="flex justify-center gap-4 mb-8">
            <div class="w-4 h-4 rounded-full bg-slate-700 pin-dot transition-all duration-200"></div>
            <div class="w-4 h-4 rounded-full bg-slate-700 pin-dot transition-all duration-200"></div>
            <div class="w-4 h-4 rounded-full bg-slate-700 pin-dot transition-all duration-200"></div>
            <div class="w-4 h-4 rounded-full bg-slate-700 pin-dot transition-all duration-200"></div>
        </div>

        <!-- Keypad -->
        <div class="grid grid-cols-3 gap-4 w-full max-w-xs">
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="1">1</button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="2">2</button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="3">3</button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="4">4</button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="5">5</button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="6">6</button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="7">7</button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="8">8</button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="9">9</button>
            <button class="h-16 rounded-2xl bg-transparent text-slate-500 flex items-center justify-center" id="restore-btn"><span class="text-xs font-bold">RESTAURER</span></button>
            <button class="pin-btn h-16 rounded-2xl bg-slate-800 text-white text-2xl font-bold active:bg-blue-600 transition-colors" data-val="0">0</button>
            <button class="h-16 rounded-2xl bg-transparent text-red-400 flex items-center justify-center" id="clear-pin"><i class="ph-bold ph-backspace text-2xl"></i></button>
        </div>
        <input type="file" id="restore-file-input" accept=".json" class="hidden">
        
        <!-- Mode Kiosque Link -->
        <button id="open-kiosk-btn" class="mt-8 text-slate-500 text-sm font-bold flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800">
            <i class="ph-bold ph-scan"></i> Mode Kiosque (Scan Seul)
        </button>
    </div>

    <!-- VUE PRINCIPALE (APP) -->
    <div id="main-view" class="hidden flex-1 flex flex-col h-full bg-slate-50">
        
        <!-- Header -->
        <header class="bg-white px-4 py-3 flex justify-between items-center border-b border-slate-200 z-20 shadow-sm shrink-0">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-1.5 rounded-lg">
                    <i class="ph-bold ph-barbell text-white text-lg"></i>
                </div>
                <h1 id="app-title-display" class="font-bold text-slate-800 truncate max-w-[150px]">FIT TRACK</h1>
            </div>
            <div class="flex gap-2">
                <button id="main-scan-btn" class="bg-slate-800 text-white px-3 py-2 rounded-lg font-bold text-sm flex items-center gap-2 active:scale-95 transition-transform">
                    <i class="ph-bold ph-qr-code"></i> SCANNER
                </button>
                <button id="logout-btn" class="bg-slate-100 text-slate-600 p-2 rounded-lg active:bg-slate-200">
                    <i class="ph-bold ph-sign-out text-xl"></i>
                </button>
            </div>
        </header>

        <!-- Contenu Scrollable -->
        <main class="flex-1 overflow-y-auto pb-24" id="content-area">
            
            <!-- ACCUEIL -->
            <div id="tab-dashboard" class="p-4 space-y-4">
                <!-- Stats Rapides -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-green-100 rounded-lg text-green-600"><i class="ph-fill ph-check-circle text-xl"></i></div>
                            <span class="text-2xl font-black text-slate-800" id="stat-active">0</span>
                        </div>
                        <p class="text-xs font-bold text-slate-500 uppercase">Membres Actifs</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-orange-100 rounded-lg text-orange-600"><i class="ph-fill ph-clock-countdown text-xl"></i></div>
                            <span class="text-2xl font-black text-slate-800" id="stat-expiring">0</span>
                        </div>
                        <p class="text-xs font-bold text-slate-500 uppercase">Fin Bientôt</p>
                    </div>
                </div>

                <!-- Finance Card -->
                <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-slate-400 text-xs font-bold uppercase">Bilan du Mois</p>
                        <i class="ph-fill ph-chart-line-up text-green-400 text-xl"></i>
                    </div>
                    <p id="stat-revenue" class="text-3xl font-black mb-1">0 F</p>
                    <div class="h-px bg-slate-700 my-3"></div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Charges: <span id="stat-expense" class="text-red-400 font-bold">0 F</span></span>
                        <span class="text-slate-400">Net: <span id="stat-net" class="text-emerald-400 font-bold">0 F</span></span>
                    </div>
                </div>

                <div class="pt-4">
                    <h3 class="font-bold text-lg mb-3 px-1">Actions Rapides</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="nav-add-member" class="bg-blue-600 text-white p-4 rounded-2xl font-bold text-left shadow-lg shadow-blue-200 active:scale-[0.98] transition-transform">
                            <i class="ph-bold ph-user-plus text-2xl mb-2"></i><br>Nouveau Client
                        </button>
                        <button id="nav-add-charge" class="bg-white text-slate-800 border border-slate-200 p-4 rounded-2xl font-bold text-left active:scale-[0.98] transition-transform">
                            <i class="ph-bold ph-receipt text-2xl mb-2 text-red-500"></i><br>Ajouter Charge
                        </button>
                    </div>
                </div>
            </div>

            <!-- MEMBRES -->
            <div id="tab-members" class="hidden p-4">
                <div class="sticky top-0 bg-slate-50 pt-1 pb-3 z-10 space-y-3">
                    <div class="relative">
                        <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="search-member" placeholder="Chercher un nom..." class="w-full pl-11 pr-4 py-3.5 rounded-xl border-none shadow-sm bg-white focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-1 hide-scrollbar">
                        <button class="filter-chip active bg-slate-800 text-white px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap" data-f="all">Tous</button>
                        <button class="filter-chip bg-white text-slate-600 border px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap" data-f="active">Actifs</button>
                        <button class="filter-chip bg-white text-slate-600 border px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap" data-f="session">Séances</button>
                        <button class="filter-chip bg-white text-slate-600 border px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap" data-f="expired">Expirés</button>
                    </div>
                </div>
                <div id="members-list" class="space-y-3 pb-20"></div>
            </div>

            <!-- HISTORIQUE (PRESENCES) -->
            <div id="tab-history" class="hidden p-4">
                <h2 class="font-bold text-xl mb-4">Historique de Pointage</h2>
                <div id="sessions-list" class="space-y-6"></div>
            </div>

            <!-- OPTIONS -->
            <div id="tab-settings" class="hidden p-4 space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-lg mb-3">Mon Établissement</h3>
                    <input type="text" id="config-gym-name" class="w-full p-3 bg-slate-50 rounded-xl border-none font-bold text-slate-700 mb-3">
                    <button id="save-config-btn" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Enregistrer le nom</button>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-lg mb-3">Données & Rapports</h3>
                    <div class="space-y-3">
                        <button id="export-csv-btn" class="w-full flex items-center justify-between p-3 bg-slate-50 rounded-xl font-bold text-slate-700 active:bg-slate-100">
                            <span><i class="ph-bold ph-file-csv mr-2 text-green-600"></i> Rapport Détaillé (CSV)</span>
                            <i class="ph-bold ph-caret-right"></i>
                        </button>
                        <button id="backup-json-btn" class="w-full flex items-center justify-between p-3 bg-slate-50 rounded-xl font-bold text-slate-700 active:bg-slate-100">
                            <span><i class="ph-bold ph-floppy-disk mr-2 text-blue-600"></i> Sauvegarde Complète (JSON)</span>
                            <i class="ph-bold ph-caret-right"></i>
                        </button>
                         <button id="reset-data-btn" class="w-full flex items-center justify-between p-3 bg-red-50 rounded-xl font-bold text-red-600 active:bg-red-100">
                            <span><i class="ph-bold ph-trash mr-2"></i> Réinitialiser tout</span>
                        </button>
                    </div>
                </div>
                <p class="text-center text-xs text-slate-400 mt-4">Version Locale 2.0 - Données stockées sur l'appareil</p>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-slate-200 pb-safe shrink-0 z-30">
            <div class="flex justify-around items-center h-16">
                <button class="nav-item active flex-1 h-full flex flex-col items-center justify-center text-blue-600" data-tab="dashboard">
                    <i class="ph-fill ph-house text-2xl mb-1"></i>
                    <span class="text-[10px] font-bold">Accueil</span>
                </button>
                <button class="nav-item flex-1 h-full flex flex-col items-center justify-center text-slate-400" data-tab="members">
                    <i class="ph-bold ph-users text-2xl mb-1"></i>
                    <span class="text-[10px] font-bold">Clients</span>
                </button>
                <button class="nav-item flex-1 h-full flex flex-col items-center justify-center text-slate-400" data-tab="history">
                    <i class="ph-bold ph-clock-counter-clockwise text-2xl mb-1"></i>
                    <span class="text-[10px] font-bold">Pointage</span>
                </button>
                <button class="nav-item flex-1 h-full flex flex-col items-center justify-center text-slate-400" data-tab="settings">
                    <i class="ph-bold ph-gear text-2xl mb-1"></i>
                    <span class="text-[10px] font-bold">Options</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- --- MODALS --- -->

    <!-- Modal Ajout/Edit Membre -->
    <div id="modal-member" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full h-[92vh] sm:h-auto sm:max-w-lg rounded-t-3xl sm:rounded-3xl flex flex-col overflow-hidden fade-in">
            <div class="px-5 py-4 border-b flex justify-between items-center bg-slate-50">
                <button class="close-modal text-slate-400 p-2 hover:text-slate-800"><i class="ph-bold ph-x text-xl"></i></button>
                <h2 class="font-bold text-lg text-slate-800" id="modal-member-title">Nouveau Client</h2>
                <div class="w-8"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-5">
                <input type="hidden" id="inp-id">
                
                <!-- Photo Section -->
                <div class="flex justify-center">
                    <div class="relative w-28 h-28 bg-slate-100 rounded-full overflow-hidden border-4 border-white shadow-lg group">
                        <img id="inp-photo-preview" class="w-full h-full object-cover hidden">
                        <div id="inp-photo-placeholder" class="w-full h-full flex flex-col items-center justify-center text-slate-400">
                            <i class="ph-fill ph-camera text-3xl"></i>
                        </div>
                        <input type="file" id="inp-photo" accept="image/*" capture="environment" class="absolute inset-0 opacity-0 z-10 cursor-pointer">
                    </div>
                </div>

                <!-- Infos -->
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="inp-firstname" placeholder="Prénom" class="w-full p-3.5 bg-slate-50 rounded-xl border-none font-semibold">
                    <input type="text" id="inp-lastname" placeholder="Nom" class="w-full p-3.5 bg-slate-50 rounded-xl border-none font-semibold">
                </div>
                <input type="tel" id="inp-phone" placeholder="Téléphone" class="w-full p-3.5 bg-slate-50 rounded-xl border-none font-semibold">
                
                <!-- Type Abonnement -->
                <div class="bg-slate-50 p-4 rounded-xl space-y-3">
                    <div class="flex bg-slate-200 p-1 rounded-lg">
                        <button type="button" id="btn-type-sub" class="flex-1 py-2 rounded-md text-sm font-bold shadow bg-white text-blue-600 transition-all">Abonnement</button>
                        <button type="button" id="btn-type-sess" class="flex-1 py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition-all">Carnet</button>
                    </div>
                    <input type="hidden" id="inp-type" value="subscription">

                    <div id="block-sub">
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Durée (Mois)</label>
                        <div class="flex gap-2 mt-1">
                            <button type="button" class="dur-btn flex-1 py-3 bg-white border rounded-xl font-bold text-slate-600" onclick="setDuration(1)">1</button>
                            <button type="button" class="dur-btn flex-1 py-3 bg-white border rounded-xl font-bold text-slate-600" onclick="setDuration(3)">3</button>
                            <button type="button" class="dur-btn flex-1 py-3 bg-white border rounded-xl font-bold text-slate-600" onclick="setDuration(6)">6</button>
                            <button type="button" class="dur-btn flex-1 py-3 bg-white border rounded-xl font-bold text-slate-600" onclick="setDuration(12)">12</button>
                        </div>
                        <input type="number" id="inp-duration" placeholder="Ou nombre de mois..." class="w-full mt-2 p-3 bg-white rounded-xl border-none">
                    </div>

                    <div id="block-sess" class="hidden">
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Nombre de séances</label>
                        <div class="flex gap-2 mt-1">
                            <button type="button" class="sess-btn flex-1 py-3 bg-white border rounded-xl font-bold text-slate-600" onclick="setSessions(10)">10</button>
                            <button type="button" class="sess-btn flex-1 py-3 bg-white border rounded-xl font-bold text-slate-600" onclick="setSessions(20)">20</button>
                        </div>
                        <input type="number" id="inp-sessions" placeholder="Ou nombre de séances..." class="w-full mt-2 p-3 bg-white rounded-xl border-none">
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Montant Payé (FCFA)</label>
                        <input type="number" id="inp-amount" class="w-full p-3.5 bg-green-50 text-green-700 font-bold rounded-xl border border-green-100 mt-1" placeholder="0">
                    </div>
                </div>
                
                <!-- Infos Supplémentaires -->
                <div class="space-y-2">
                    <input type="text" id="inp-address" placeholder="Lieu de résidence" class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm">
                    <textarea id="inp-medical" placeholder="Antécédents médicaux..." class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm h-20"></textarea>
                    <input type="text" id="inp-emergency" placeholder="Contact d'urgence (Nom & Tél)" class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm">
                </div>

            </div>
            <div class="p-4 border-t bg-white pb-safe">
                <button id="btn-save-member" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg shadow-slate-300 active:scale-[0.98] transition-transform">Valider Inscription</button>
            </div>
        </div>
    </div>

    <!-- Modal Scan Résultat -->
    <div id="modal-scan-result" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl relative">
            <button onclick="closeScanResult()" class="absolute top-4 right-4 bg-slate-100 p-2 rounded-full text-slate-500"><i class="ph-bold ph-x"></i></button>
            
            <div class="p-6 text-center pt-10">
                <div class="w-32 h-32 mx-auto rounded-full bg-slate-200 mb-4 border-8 border-white shadow-lg overflow-hidden relative">
                    <img id="scan-photo" class="w-full h-full object-cover hidden">
                    <i id="scan-icon" class="ph-fill ph-user text-6xl text-slate-300 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                </div>
                
                <h2 id="scan-name" class="text-2xl font-black text-slate-800 leading-tight mb-1">Nom Client</h2>
                <p id="scan-phone" class="text-slate-400 text-sm font-medium mb-4">0102030405</p>
                
                <div id="scan-status-box" class="bg-green-100 text-green-700 p-4 rounded-2xl mb-4 border border-green-200">
                    <p class="text-xs font-bold uppercase opacity-70 mb-1">Statut</p>
                    <p id="scan-status-text" class="text-xl font-black">ACCÈS AUTORISÉ</p>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-left bg-slate-50 p-3 rounded-xl text-sm">
                    <div>
                        <p class="text-slate-400 text-xs font-bold uppercase">Info</p>
                        <p id="scan-info" class="font-bold text-slate-700">-</p>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs font-bold uppercase">Expiration</p>
                        <p id="scan-detail" class="font-bold text-slate-700">-</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-slate-50 border-t">
                <button onclick="closeScanResult()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200">OK, Suivant</button>
            </div>
        </div>
    </div>

    <!-- Modal Vue Détail -->
    <div id="modal-view-member" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full h-[85vh] sm:h-auto sm:max-w-md rounded-t-3xl sm:rounded-3xl flex flex-col overflow-hidden">
             <div class="bg-slate-800 text-white p-6 pb-10 rounded-b-[2rem] relative shrink-0">
                 <div class="flex justify-between items-start mb-4">
                     <button onclick="closeViewMember()" class="bg-white/20 p-2 rounded-full hover:bg-white/30"><i class="ph-bold ph-arrow-left"></i></button>
                     <div class="flex gap-2">
                         <button id="btn-share-wa" class="bg-green-500 p-2 rounded-full shadow-lg"><i class="ph-fill ph-whatsapp-logo text-lg"></i></button>
                         <button id="btn-delete-member" class="bg-red-500 p-2 rounded-full shadow-lg"><i class="ph-bold ph-trash text-lg"></i></button>
                     </div>
                 </div>
                 <div class="flex items-center gap-4">
                     <div class="w-20 h-20 rounded-full bg-white/10 border-2 border-white/30 overflow-hidden shrink-0">
                         <img id="view-photo" class="w-full h-full object-cover hidden">
                         <div id="view-icon" class="w-full h-full flex items-center justify-center"><i class="ph-fill ph-user text-4xl text-white/50"></i></div>
                     </div>
                     <div>
                         <h2 id="view-name" class="text-2xl font-bold leading-tight">Nom Prénom</h2>
                         <p id="view-phone" class="text-slate-400 font-medium">Tél</p>
                     </div>
                 </div>
             </div>
             
             <div class="flex-1 overflow-y-auto p-6 -mt-6">
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 mb-4">
                     <div class="flex justify-between items-center mb-2">
                         <span class="text-xs font-bold text-slate-400 uppercase">Abonnement Actuel</span>
                         <span id="view-status-badge" class="px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-700">ACTIF</span>
                     </div>
                     <p id="view-subscription-detail" class="text-xl font-black text-slate-800">1 Mois</p>
                     <p id="view-subscription-date" class="text-sm text-slate-500">Fin le 12/12/2024</p>
                 </div>
                 
                 <div class="space-y-2 text-sm text-slate-600 bg-slate-50 p-4 rounded-2xl mb-4">
                     <p><i class="ph-bold ph-map-pin mr-2 text-slate-400"></i> <span id="view-address">-</span></p>
                     <p><i class="ph-bold ph-first-aid mr-2 text-red-400"></i> <span id="view-medical">-</span></p>
                     <p><i class="ph-bold ph-phone-call mr-2 text-orange-400"></i> <span id="view-emergency">-</span></p>
                 </div>

                 <button id="btn-renew" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 mb-2">Renouveler / Convertir</button>
                 <button id="btn-show-qr" class="w-full bg-white border border-slate-200 text-slate-700 py-3 rounded-xl font-bold">Voir QR Code</button>
             </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="modal-scanner" class="fixed inset-0 bg-black z-[100] hidden flex flex-col">
        <div class="p-4 flex justify-between items-center text-white z-10">
            <h2 class="font-bold text-lg">Scanner QR</h2>
            <button onclick="stopScanner()" class="bg-white/20 p-2 rounded-full"><i class="ph-bold ph-x text-xl"></i></button>
        </div>
        <div id="qr-reader" class="flex-1 bg-black relative"></div>
        <p class="text-center text-white/70 pb-8 p-4 text-sm">Pointez la caméra vers le code du client</p>
    </div>

    <!-- Modal Charge -->
    <div id="modal-charge" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl fade-in">
            <h3 class="font-bold text-lg mb-4">Ajouter une dépense</h3>
            <input type="text" id="charge-desc" placeholder="Motif (ex: Facture Eau)" class="w-full p-3 bg-slate-50 rounded-xl mb-3 border-none">
            <input type="number" id="charge-amount" placeholder="Montant (FCFA)" class="w-full p-3 bg-slate-50 rounded-xl mb-5 border-none font-bold text-red-600">
            <div class="flex gap-3">
                <button onclick="document.getElementById('modal-charge').classList.add('hidden')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">Annuler</button>
                <button onclick="saveCharge()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200">Valider</button>
            </div>
        </div>
    </div>

    <!-- LOGIQUE JS -->
    <script>
        // --- CONFIG ---
        const DB_KEY = 'fittrack_pro_v1';
        const PIN_CODE = "5008";
        
        // --- STATE ---
        let db = { 
            members: [], 
            finance: [], 
            sessions: [], 
            config: { name: "FIT TRACK" } 
        };
        let html5QrCode = null;
        let currentPin = "";
        let currentMemberId = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // Si pas de données, on reste sur login. Sinon on pourrait auto-login si session persistante (optionnel)
            setupPinPad();
            setupAppEvents();
            refreshUI();
        });

        function loadData() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    db = { ...db, ...parsed }; // Merge pour éviter perte si structure change
                } catch(e) { console.error("Err Data"); }
            }
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            refreshUI();
        }

        // --- AUTHENTICATION (PIN) ---
        function setupPinPad() {
            document.querySelectorAll('.pin-btn').forEach(btn => {
                btn.onclick = () => {
                    if(currentPin.length < 4) {
                        currentPin += btn.dataset.val;
                        updatePinDots();
                        if(currentPin.length === 4) checkPin();
                    }
                };
            });
            document.getElementById('clear-pin').onclick = () => {
                currentPin = currentPin.slice(0, -1);
                updatePinDots();
            };
            // Restauration au login
            document.getElementById('restore-btn').onclick = () => document.getElementById('restore-file-input').click();
            document.getElementById('restore-file-input').onchange = importJSON;
            
            // Kiosque rapide
            document.getElementById('open-kiosk-btn').onclick = () => {
                document.getElementById('login-view').classList.add('hidden');
                startScanner(true); // True = Kiosk mode (boucle)
            };
        }

        function updatePinDots() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, i) => {
                dot.className = `w-4 h-4 rounded-full transition-all duration-200 ${i < currentPin.length ? 'bg-blue-500 scale-110' : 'bg-slate-700'}`;
            });
        }

        function checkPin() {
            setTimeout(() => {
                if(currentPin === PIN_CODE) {
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('main-view').classList.remove('hidden');
                    document.getElementById('app-title-display').textContent = db.config.name;
                    currentPin = "";
                    updatePinDots();
                } else {
                    navigator.vibrate?.(200);
                    currentPin = "";
                    updatePinDots();
                    alert("Code Erroné");
                }
            }, 100);
        }

        // --- NAVIGATION & UI ---
        function setupAppEvents() {
            // Tabs Bottom
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.onclick = () => {
                    // Reset styles
                    document.querySelectorAll('.nav-item').forEach(b => {
                        b.className = "nav-item flex-1 h-full flex flex-col items-center justify-center text-slate-400";
                        b.querySelector('i').classList.replace('ph-fill', 'ph-bold');
                    });
                    // Active style
                    btn.className = "nav-item active flex-1 h-full flex flex-col items-center justify-center text-blue-600";
                    btn.querySelector('i').classList.replace('ph-bold', 'ph-fill');
                    
                    // Show Section
                    ['dashboard', 'members', 'history', 'settings'].forEach(t => {
                        document.getElementById(`tab-${t}`).classList.add('hidden');
                    });
                    document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
                };
            });

            // Actions Dashboard
            document.getElementById('nav-add-member').onclick = () => openMemberModal();
            document.getElementById('nav-add-charge').onclick = () => document.getElementById('modal-charge').classList.remove('hidden');
            
            // Scanner
            document.getElementById('main-scan-btn').onclick = () => startScanner(false);

            // Logout
            document.getElementById('logout-btn').onclick = () => {
                document.getElementById('main-view').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
            };

            // Members Filter
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.onclick = (e) => {
                    document.querySelectorAll('.filter-chip').forEach(c => {
                        c.classList.remove('bg-slate-800', 'text-white');
                        c.classList.add('bg-white', 'text-slate-600', 'border');
                    });
                    e.target.classList.remove('bg-white', 'text-slate-600', 'border');
                    e.target.classList.add('bg-slate-800', 'text-white');
                    renderMembers(e.target.dataset.f, document.getElementById('search-member').value);
                };
            });
            document.getElementById('search-member').oninput = (e) => {
                const activeFilter = document.querySelector('.filter-chip.bg-slate-800').dataset.f;
                renderMembers(activeFilter, e.target.value);
            };

            // Member Form
            document.querySelector('#modal-member .close-modal').onclick = () => document.getElementById('modal-member').classList.add('hidden');
            document.getElementById('btn-type-sub').onclick = () => setSubMode('subscription');
            document.getElementById('btn-type-sess').onclick = () => setSubMode('session');
            document.getElementById('inp-photo').onchange = handlePhoto;
            document.getElementById('btn-save-member').onclick = saveMember;

            // Settings
            document.getElementById('save-config-btn').onclick = () => {
                db.config.name = document.getElementById('config-gym-name').value;
                saveData();
                document.getElementById('app-title-display').textContent = db.config.name;
                alert("Nom enregistré");
            };
            document.getElementById('backup-json-btn').onclick = exportJSON;
            document.getElementById('export-csv-btn').onclick = exportCSV;
            document.getElementById('reset-data-btn').onclick = () => {
                if(confirm("CODE 5008 REQUIS : Voulez-vous tout effacer ?")) {
                    const p = prompt("Confirmez le code :");
                    if(p === PIN_CODE) { localStorage.removeItem(DB_KEY); location.reload(); }
                }
            };
        }

        function refreshUI() {
            renderDashboard();
            renderMembers('all');
            renderHistory();
            document.getElementById('config-gym-name').value = db.config.name;
        }

        // --- MEMBERS LOGIC ---
        function openMemberModal(memberId = null) {
            // Reset Form
            document.getElementById('inp-id').value = "";
            document.getElementById('inp-firstname').value = "";
            document.getElementById('inp-lastname').value = "";
            document.getElementById('inp-phone').value = "";
            document.getElementById('inp-address').value = "";
            document.getElementById('inp-medical').value = "";
            document.getElementById('inp-emergency').value = "";
            document.getElementById('inp-photo').value = "";
            document.getElementById('inp-photo-preview').classList.add('hidden');
            document.getElementById('inp-photo-placeholder').classList.remove('hidden');
            document.getElementById('inp-amount').value = "";
            
            // Default mode
            setSubMode('subscription');

            if(memberId) {
                // Edit Mode (Pre-fill)
                const m = db.members.find(x => x.id === memberId);
                if(m) {
                    document.getElementById('modal-member-title').textContent = "Modifier / Renouveler";
                    document.getElementById('inp-id').value = m.id;
                    document.getElementById('inp-firstname').value = m.firstname;
                    document.getElementById('inp-lastname').value = m.lastname;
                    document.getElementById('inp-phone').value = m.phone;
                    document.getElementById('inp-address').value = m.address || "";
                    document.getElementById('inp-medical').value = m.medical || "";
                    document.getElementById('inp-emergency').value = m.emergency || "";
                    
                    if(m.photo) {
                        document.getElementById('inp-photo-preview').src = m.photo;
                        document.getElementById('inp-photo-preview').classList.remove('hidden');
                        document.getElementById('inp-photo-placeholder').classList.add('hidden');
                    }
                    
                    // On garde le type existant pour l'édition
                    setSubMode(m.type);
                }
            } else {
                document.getElementById('modal-member-title').textContent = "Nouveau Client";
            }

            document.getElementById('modal-member').classList.remove('hidden');
        }

        function setSubMode(mode) {
            document.getElementById('inp-type').value = mode;
            if(mode === 'subscription') {
                document.getElementById('btn-type-sub').className = "flex-1 py-2 rounded-md text-sm font-bold shadow bg-white text-blue-600 transition-all";
                document.getElementById('btn-type-sess').className = "flex-1 py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition-all";
                document.getElementById('block-sub').classList.remove('hidden');
                document.getElementById('block-sess').classList.add('hidden');
            } else {
                document.getElementById('btn-type-sub').className = "flex-1 py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-white/50 transition-all";
                document.getElementById('btn-type-sess').className = "flex-1 py-2 rounded-md text-sm font-bold shadow bg-white text-blue-600 transition-all";
                document.getElementById('block-sub').classList.add('hidden');
                document.getElementById('block-sess').classList.remove('hidden');
            }
        }
        
        // Helpers for buttons
        window.setDuration = (m) => document.getElementById('inp-duration').value = m;
        window.setSessions = (s) => document.getElementById('inp-sessions').value = s;

        function handlePhoto(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.src = evt.target.result;
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        const scale = 300 / img.width; // Resize to 300px width
                        c.width = 300;
                        c.height = img.height * scale;
                        const ctx = c.getContext('2d');
                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        const res = c.toDataURL('image/jpeg', 0.7);
                        document.getElementById('inp-photo-preview').src = res;
                        document.getElementById('inp-photo-preview').classList.remove('hidden');
                        document.getElementById('inp-photo-placeholder').classList.add('hidden');
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        function saveMember() {
            const id = document.getElementById('inp-id').value || Date.now().toString();
            const isNew = !db.members.find(m => m.id === id);
            const type = document.getElementById('inp-type').value;
            
            if(!document.getElementById('inp-lastname').value) return alert("Nom requis");

            let member = isNew ? { id, joined: new Date().toISOString() } : db.members.find(m => m.id === id);
            
            // Basic Info
            member.firstname = document.getElementById('inp-firstname').value;
            member.lastname = document.getElementById('inp-lastname').value;
            member.phone = document.getElementById('inp-phone').value;
            member.address = document.getElementById('inp-address').value;
            member.medical = document.getElementById('inp-medical').value;
            member.emergency = document.getElementById('inp-emergency').value;
            member.type = type;

            // Photo
            if(!document.getElementById('inp-photo-preview').classList.contains('hidden')) {
                member.photo = document.getElementById('inp-photo-preview').src;
            }

            // Sub Logic
            const amount = parseFloat(document.getElementById('inp-amount').value) || 0;
            
            if(type === 'subscription') {
                const dur = parseInt(document.getElementById('inp-duration').value);
                if(dur > 0) {
                    const baseDate = (member.end && new Date(member.end) > new Date()) ? new Date(member.end) : new Date();
                    baseDate.setMonth(baseDate.getMonth() + dur);
                    member.end = baseDate.toISOString();
                    // Convert from session if needed: Remove session fields
                    delete member.sessionsTotal;
                    delete member.sessionsLeft;
                }
            } else {
                const sess = parseInt(document.getElementById('inp-sessions').value);
                if(sess > 0) {
                    // Logic Carnet: Si conversion ou ajout
                    member.sessionsTotal = (member.sessionsTotal || 0) + sess; // Cumul pour stats
                    member.sessionsLeft = (member.sessionsLeft || 0) + sess;
                    // Remove sub fields
                    delete member.end;
                }
            }

            // Finance Log
            if(amount > 0) {
                db.finance.push({
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    type: 'in',
                    desc: `${member.firstname} ${member.lastname} (${type === 'subscription' ? 'Abo' : 'Carnet'})`,
                    amount: amount
                });
            }

            if(isNew) db.members.push(member);
            saveData();
            document.getElementById('modal-member').classList.add('hidden');
        }

        // --- RENDERERS ---
        function renderDashboard() {
            let active = 0, expiring = 0, revenue = 0, expense = 0;
            const now = new Date();
            const startMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            db.members.forEach(m => {
                const s = getMemberStatus(m);
                if(s.code === 'active') active++;
                if(s.code === 'expiring') { active++; expiring++; }
            });

            db.finance.forEach(f => {
                if(new Date(f.date) >= startMonth) {
                    if(f.type === 'in') revenue += f.amount;
                    else expense += f.amount;
                }
            });

            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-expiring').textContent = expiring;
            document.getElementById('stat-revenue').textContent = revenue.toLocaleString('fr-FR') + ' F';
            document.getElementById('stat-expense').textContent = expense.toLocaleString('fr-FR') + ' F';
            document.getElementById('stat-net').textContent = (revenue - expense).toLocaleString('fr-FR') + ' F';
        }

        function getMemberStatus(m) {
            if(m.type === 'subscription') {
                if(!m.end) return { code: 'invalid', label: 'Invalide', color: 'red' };
                const end = new Date(m.end);
                const days = Math.ceil((end - new Date()) / (1000 * 3600 * 24));
                if(days < 0) return { code: 'expired', label: 'Expiré', color: 'red' };
                if(days <= 7) return { code: 'expiring', label: 'Fin ' + days + 'j', color: 'orange' };
                return { code: 'active', label: 'Actif', color: 'green' };
            } else {
                if(!m.sessionsLeft || m.sessionsLeft <= 0) return { code: 'expired', label: '0 Séance', color: 'red' };
                return { code: 'active', label: m.sessionsLeft + ' Séances', color: 'blue' };
            }
        }

        function renderMembers(filter, query = "") {
            const list = document.getElementById('members-list');
            list.innerHTML = "";
            
            const q = query.toLowerCase();
            const filtered = db.members.filter(m => {
                const s = getMemberStatus(m);
                const matchesQ = (m.firstname + " " + m.lastname).toLowerCase().includes(q);
                
                if(!matchesQ) return false;
                if(filter === 'all') return true;
                if(filter === 'active') return s.code === 'active' || s.code === 'expiring';
                if(filter === 'session') return m.type === 'session' && s.code !== 'expired';
                if(filter === 'expired') return s.code === 'expired';
                return true;
            }).sort((a,b) => a.lastname.localeCompare(b.lastname));

            filtered.forEach(m => {
                const s = getMemberStatus(m);
                const colorClass = s.color === 'green' ? 'bg-green-100 text-green-700' : 
                                   s.color === 'orange' ? 'bg-orange-100 text-orange-700' :
                                   s.color === 'blue' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700';

                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl flex items-center justify-between shadow-sm border border-slate-100 active:scale-[0.99] transition-transform";
                div.onclick = () => openViewMember(m.id);
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-slate-100 overflow-hidden shrink-0">
                            ${m.photo ? `<img src="${m.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center"><i class="ph-fill ph-user text-slate-300 text-xl"></i></div>`}
                        </div>
                        <div>
                            <p class="font-bold text-slate-800 leading-tight">${m.firstname} ${m.lastname}</p>
                            <p class="text-xs text-slate-400 mt-0.5">${m.type === 'subscription' ? (m.end ? new Date(m.end).toLocaleDateString() : '-') : 'Carnet'}</p>
                        </div>
                    </div>
                    <div class="px-3 py-1 rounded-full text-xs font-bold ${colorClass}">
                        ${s.label}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function openViewMember(id) {
            currentMemberId = id;
            const m = db.members.find(x => x.id === id);
            const s = getMemberStatus(m);

            document.getElementById('view-name').textContent = `${m.firstname} ${m.lastname}`;
            document.getElementById('view-phone').textContent = m.phone;
            
            const photoEl = document.getElementById('view-photo');
            const iconEl = document.getElementById('view-icon');
            if(m.photo) {
                photoEl.src = m.photo; photoEl.classList.remove('hidden'); iconEl.classList.add('hidden');
            } else {
                photoEl.classList.add('hidden'); iconEl.classList.remove('hidden');
            }

            // Status Badge
            const badge = document.getElementById('view-status-badge');
            badge.textContent = s.label.toUpperCase();
            badge.className = `px-2 py-0.5 rounded-full text-xs font-bold ${s.color === 'green' ? 'bg-green-100 text-green-700' : s.color === 'blue' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}`;

            // Details Sub
            if(m.type === 'subscription') {
                document.getElementById('view-subscription-detail').textContent = "Abonnement";
                document.getElementById('view-subscription-date').textContent = m.end ? `Fin le : ${new Date(m.end).toLocaleDateString()}` : "Pas de date";
            } else {
                document.getElementById('view-subscription-detail').textContent = "Carnet Séances";
                document.getElementById('view-subscription-date').textContent = `Solde : ${m.sessionsLeft} / ${m.sessionsTotal || '?'}`;
            }

            // Infos
            document.getElementById('view-address').textContent = m.address || "Non renseigné";
            document.getElementById('view-medical').textContent = m.medical || "RAS";
            document.getElementById('view-emergency').textContent = m.emergency || "Non renseigné";

            // Actions
            document.getElementById('btn-renew').onclick = () => {
                document.getElementById('modal-view-member').classList.add('hidden');
                openMemberModal(id); // Opens edit/renew modal
            };
            
            document.getElementById('btn-show-qr').onclick = () => {
                const win = window.open("", "QR", "width=300,height=400");
                win.document.write(`<html><body style="text-align:center;font-family:sans-serif"><h2>${m.firstname}</h2><div id="q"></div><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script><script>new QRCode(document.getElementById("q"), {text:"${m.id}",width:200,height:200})<\/script></body></html>`);
            };
            
            document.getElementById('btn-share-wa').onclick = () => {
                const txt = `*${db.config.name}*\nClient: ${m.firstname} ${m.lastname}\nStatut: ${s.label}\nFin: ${m.end ? new Date(m.end).toLocaleDateString() : '-'}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
            };

            document.getElementById('btn-delete-member').onclick = () => {
                if(confirm("ATTENTION : Supprimer ce client ?")) {
                    const p = prompt("Code PIN de sécurité :");
                    if(p === PIN_CODE) {
                        db.members = db.members.filter(x => x.id !== id);
                        saveData();
                        document.getElementById('modal-view-member').classList.add('hidden');
                        refreshUI();
                    } else {
                        alert("Code incorrect");
                    }
                }
            };

            document.getElementById('modal-view-member').classList.remove('hidden');
        }
        
        function closeViewMember() { document.getElementById('modal-view-member').classList.add('hidden'); }

        // --- CHARGES ---
        function saveCharge() {
            const desc = document.getElementById('charge-desc').value;
            const amount = parseFloat(document.getElementById('charge-amount').value);
            if(desc && amount) {
                db.finance.push({
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    type: 'out',
                    desc: desc,
                    amount: amount
                });
                saveData();
                document.getElementById('modal-charge').classList.add('hidden');
            }
        }

        // --- HISTORY (PRESENCES) ---
        function renderHistory() {
            const list = document.getElementById('sessions-list');
            list.innerHTML = "";
            
            // Group by date
            const groups = {};
            db.sessions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                const day = new Date(s.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                if(!groups[day]) groups[day] = [];
                groups[day].push(s);
            });

            Object.keys(groups).forEach(day => {
                const dayHeader = document.createElement('h3');
                dayHeader.className = "text-xs font-bold text-slate-400 uppercase tracking-wider mt-4 mb-2";
                dayHeader.textContent = day;
                list.appendChild(dayHeader);

                groups[day].forEach(s => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center mb-2";
                    div.innerHTML = `
                        <span class="font-bold text-slate-700">${s.name}</span>
                        <span class="text-sm text-slate-400 font-mono bg-slate-100 px-2 py-1 rounded-lg">${new Date(s.date).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}</span>
                    `;
                    list.appendChild(div);
                });
            });
        }

        // --- SCANNER LOGIC ---
        function startScanner(kioskMode) {
            document.getElementById('modal-scanner').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    if(!kioskMode) stopScanner();
                    handleScanResult(decodedText);
                }
            );
        }

        function stopScanner() {
            if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear());
            document.getElementById('modal-scanner').classList.add('hidden');
        }

        function handleScanResult(id) {
            const m = db.members.find(x => x.id === id);
            const modal = document.getElementById('modal-scan-result');
            const box = document.getElementById('scan-status-box');
            const txt = document.getElementById('scan-status-text');
            
            modal.classList.remove('hidden');

            if(!m) {
                document.getElementById('scan-name').textContent = "INCONNU";
                box.className = "bg-red-100 text-red-700 p-4 rounded-2xl mb-4 border border-red-200";
                txt.textContent = "MEMBRE INTROUVABLE";
                return; // Stop here
            }

            // Display Info
            document.getElementById('scan-name').textContent = `${m.firstname} ${m.lastname}`;
            document.getElementById('scan-phone').textContent = m.phone;
            
            if(m.photo) {
                document.getElementById('scan-photo').src = m.photo;
                document.getElementById('scan-photo').classList.remove('hidden');
                document.getElementById('scan-icon').classList.add('hidden');
            } else {
                document.getElementById('scan-photo').classList.add('hidden');
                document.getElementById('scan-icon').classList.remove('hidden');
            }

            const s = getMemberStatus(m);
            
            // Update Logic (Décrémentation)
            let valid = false;
            if(s.code === 'active' || s.code === 'expiring') {
                valid = true;
                box.className = "bg-green-100 text-green-700 p-4 rounded-2xl mb-4 border border-green-200";
                txt.textContent = "ACCÈS AUTORISÉ";
                
                // Log Session
                db.sessions.push({
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    memberId: m.id,
                    name: `${m.firstname} ${m.lastname}`
                });

                // Decrement if session pack
                if(m.type === 'session') {
                    m.sessionsLeft--;
                    saveData(); // Save the decrement
                }
                saveData(); // Save the session log
            } else {
                box.className = "bg-red-100 text-red-700 p-4 rounded-2xl mb-4 border border-red-200";
                txt.textContent = "ACCÈS REFUSÉ (" + s.label + ")";
            }

            // Detail texts
            document.getElementById('scan-info').textContent = m.type === 'subscription' ? 'Abonnement' : 'Carnet';
            if(m.type === 'subscription') {
                document.getElementById('scan-detail').textContent = m.end ? new Date(m.end).toLocaleDateString() : 'Date invalide';
            } else {
                document.getElementById('scan-detail').textContent = `${m.sessionsLeft} restants`;
            }
            
            refreshUI(); // Update lists
        }

        function closeScanResult() {
            document.getElementById('modal-scan-result').classList.add('hidden');
        }

        // --- EXPORTS ---
        function exportJSON() {
            const date = new Date().toISOString().split('T')[0];
            const filename = `FitTrack_Backup_${date}.json`;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a');
            a.href = dataStr; a.download = filename; a.click();
        }

        function exportCSV() {
            let csv = "Annee;Mois;Jour;Date;Heure;Type;Description;Montant\n";
            
            // Combine payments and expenses
            const rows = [];
            
            // Charges (Out)
            db.finance.forEach(f => {
                const d = new Date(f.date);
                rows.push({
                    y: d.getFullYear(),
                    m: d.getMonth() + 1,
                    d: d.getDate(),
                    date: d.toLocaleDateString(),
                    time: d.toLocaleTimeString(),
                    type: f.type === 'in' ? 'Entree' : 'Sortie',
                    desc: f.desc,
                    amount: f.type === 'in' ? f.amount : -f.amount
                });
            });

            rows.sort((a,b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

            rows.forEach(r => {
                csv += `${r.y};${r.m};${r.d};${r.date};${r.time};${r.type};"${r.desc}";${r.amount}\n`;
            });

            const date = new Date().toISOString().split('T')[0];
            const filename = `FitTrack_Rapport_${date}.csv`;
            const uri = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            const a = document.createElement('a');
            a.href = uri; a.download = filename; a.click();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.members || json.finance) {
                        db = json;
                        saveData();
                        alert("Données restaurées avec succès !");
                        location.reload();
                    } else {
                        alert("Format de fichier invalide.");
                    }
                } catch (err) {
                    alert("Erreur lors de la lecture du fichier.");
                }
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>
